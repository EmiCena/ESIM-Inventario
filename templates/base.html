{% load static %}
{% load roles %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ESIM Inventario</title>

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/log_esim1.png' %}">
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'img/log_esim1.png' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/log_esim1.png' %}">
  <meta name="theme-color" content="#49D6D6">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/theme.css' %}">
</head>
<body>
  <header class="hero">
    <!-- blobs y burbujas decorativas -->
    <img src="{% static 'img/bg-blobs.svg' %}" alt="" class="hero-blobs">
    <span class="bubble bubble--1"></span>
    <span class="bubble bubble--2"></span>
    <span class="bubble bubble--3"></span>

    <div class="hero-inner">
      <div class="brand">
        <a href="{% url 'home' %}" class="brand-link" aria-label="Ir al inicio">
          <img src="{% static 'img/logo-esi-blanco.png' %}" alt="Escuela Secundaria de Innovación Misiones" class="logo-img">
        </a>
      </div>
      <nav class="nav">
        <a href="{% url 'home' %}" class="nav-link">Inicio</a>
        {% if request.user.is_authenticated %}
          <a href="/prestamo/" class="nav-link">Préstamo</a>
          <a href="/devolucion/" class="nav-link">Entrega</a>

          {% has_role request.user 'OPERADOR' 'STAFF' as es_operador %}
          {% if es_operador %}
            <a href="/prestamos/activos/" class="nav-link">En uso ahora</a>
            <a href="/reservas/pendientes/" class="nav-link">Reservas</a>
          {% endif %}

          <a href="/dashboard/" class="nav-link">Dashboard</a>
          <a href="/accounts/discord/" class="nav-link">Discord</a>
          <a href="/accounts/logout/" class="nav-link">Salir ({{ request.user.username }})</a>
        {% else %}
          <a href="/dashboard/" class="nav-link">Dashboard</a>
          <a href="/accounts/login/" class="nav-link">Ingresar</a>
          <a href="/accounts/signup/" class="nav-link">Registrarse</a>
        {% endif %}
        <a href="/admin/" class="nav-link">Admin</a>

        <!-- Toggle de tema (opcional) -->
        <button id="themeToggle" class="nav-btn" type="button" title="Cambiar tema">🌓</button>
      </nav>
    </div>
  </header>

  <main class="container main">
    {% if messages %}
      <div class="messages">
        {% for m in messages %}
          {% with tag=m.tags|default:"info" %}
          <div class="card msg msg-{{ tag }}">{{ m }}</div>
          {% endwith %}
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>
  
  <footer class="site-footer">
    <div class="container" style="text-align:center">
      <h3 style="margin-top:0">Contactanos</h3>
      <p>Instagram · Facebook · Twitter · WhatsApp · YouTube</p>
      <p>Emails: Nivel Superior · Info/CV · Formación Continua</p>
    </div>
  </footer>

  <!-- Animación de reveal al hacer scroll -->
  <script>
  (function(){
    const els = document.querySelectorAll('.reveal');
    if (!els.length) return;
    if (!('IntersectionObserver' in window)) { els.forEach(el=>el.classList.add('is-visible')); return; }
    const io = new IntersectionObserver((entries)=>{
      for (const e of entries){ if (e.isIntersecting){ e.target.classList.add('is-visible'); io.unobserve(e.target);} }
    }, {threshold:.14});
    els.forEach(el=>io.observe(el));
  })();
  </script>

  <!-- Toggle claro/oscuro -->
  <script>
    (function(){
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      const btn = document.getElementById('themeToggle');
      if (btn){
        btn.addEventListener('click', ()=>{
          const cur = document.documentElement.getAttribute('data-theme');
          const next = cur === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
        });
      }
    })();
  </script>

  {% if request.user.is_authenticated %}
  <!-- Chat: rediseñado para claro/oscuro -->
  <div id="chat-widget" class="chat-widget">
    <div class="chat-card">
      <div id="chat-header" class="chat-header">
        <div class="chat-title">🤖 Reservas y Devoluciones</div>
        <div class="chat-sub">click para abrir</div>
      </div>
      <div id="chat-body" class="chat-body" style="display:none;">
        <div id="chat-log" class="chat-log"></div>
        <div id="chat-suggestions" class="chat-suggestions">
          <button type="button" class="chat-chip">Menú</button>
          <button type="button" class="chat-chip">Mis reservas</button>
          <button type="button" class="chat-chip">Mis préstamos</button>
          <button type="button" class="chat-chip">Reservar NB-01</button>
          <button type="button" class="chat-chip">Devolver NB-01</button>
          <button type="button" class="chat-chip">Cancelar reserva</button>
        </div>
        <form id="chat-form" class="chat-form">
          <input id="chat-input" class="chat-input" autocomplete="off" placeholder="Escribe aquí..." />
          <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const elHeader = document.getElementById('chat-header');
    const elBody = document.getElementById('chat-body');
    const elLog = document.getElementById('chat-log');
    const elForm = document.getElementById('chat-form');
    const elInput = document.getElementById('chat-input');
    const elSugg = document.getElementById('chat-suggestions');
    const convKey = 'chat_conversation_id';
    const conversationId = localStorage.getItem(convKey) || (Date.now().toString());
    localStorage.setItem(convKey, conversationId);

    function csrftoken() {
      const m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    }
    function escHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function addMsg(role, text){
      const div = document.createElement('div');
      div.className = 'chat-bubble ' + (role === 'user' ? 'user' : 'bot');
      div.innerHTML = escHtml(text);
      elLog.appendChild(div);
      elLog.scrollTop = elLog.scrollHeight;
    }

    function renderSuggestions(suggestions){
      elSugg.innerHTML = '';
      const items = suggestions && suggestions.length
        ? suggestions
        : ['Menú','Mis reservas','Mis préstamos','Reservar NB-01','Devolver NB-01','Cancelar reserva'];
      items.forEach(txt=>{
        const b = document.createElement('button');
        b.type = 'button'; b.className = 'chat-chip'; b.textContent = txt;
        b.onclick = ()=> sendMessage(txt);
        elSugg.appendChild(b);
      });
    }

    elHeader.onclick = () => {
      elBody.style.display = (elBody.style.display === 'none') ? 'flex' : 'none';
    };

    async function sendMessage(message){
      addMsg('user', message);
      elInput.value = '';
      try {
        const res = await fetch('/api/chat/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken() },
          body: JSON.stringify({ message, conversation_id: conversationId })
        });
        const data = await res.json();
        addMsg('bot', data.reply || 'Sin respuesta.');
        renderSuggestions(data.suggestions || []);
      } catch (err) {
        addMsg('bot', 'Hubo un error. Inténtalo de nuevo.');
      }
    }

    elForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const msg = elInput.value.trim();
      if (msg) sendMessage(msg);
    });

    // Inicio
    addMsg('bot', 'Hola, soy tu asistente. Puedo reservar por código (NB-01) y registrar devoluciones. ¿Qué necesitás?');
    renderSuggestions();
  </script>
  {% endif %}
</body>
</html>